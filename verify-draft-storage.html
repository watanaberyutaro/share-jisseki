<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Draft Storage æ¤œè¨¼</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      max-width: 1000px;
      margin: 0 auto;
    }
    button {
      margin: 10px 5px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    #output {
      background: #f4f4f4;
      padding: 15px;
      border-radius: 5px;
      margin-top: 20px;
      white-space: pre-wrap;
      max-height: 600px;
      overflow-y: auto;
    }
    .success { color: green; }
    .error { color: red; }
    .info { color: blue; }
  </style>
</head>
<body>
  <h1>Draft Storage æ¤œè¨¼ãƒ„ãƒ¼ãƒ«</h1>

  <div>
    <button onclick="checkUserName()">1. ãƒ¦ãƒ¼ã‚¶ãƒ¼åç¢ºèª</button>
    <button onclick="checkAllDrafts()">2. å…¨Draftç¢ºèª</button>
    <button onclick="checkSpecificDraft()">3. ç‰¹å®šDraftç¢ºèª</button>
    <button onclick="clearAllDrafts()">4. å…¨Draftå‰Šé™¤</button>
  </div>

  <div id="output">ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™...</div>

  <script>
    function log(message, type = 'info') {
      const output = document.getElementById('output')
      const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info'
      output.innerHTML += `<div class="${className}">${new Date().toLocaleTimeString()} - ${message}</div>`
    }

    function clearLog() {
      document.getElementById('output').innerHTML = ''
    }

    function checkUserName() {
      clearLog()
      log('=== ãƒ¦ãƒ¼ã‚¶ãƒ¼åç¢ºèª ===')
      
      const userName = localStorage.getItem('userName')
      const userRole = localStorage.getItem('userRole')
      
      log(`userName: ${userName || '(æœªè¨­å®š)'}`, userName ? 'success' : 'error')
      log(`userRole: ${userRole || '(æœªè¨­å®š)'}`, userRole ? 'success' : 'error')
      
      if (userName) {
        const expectedDraftKey = `draft_performance_form_${userName}`
        log(`æœŸå¾…ã•ã‚Œã‚‹DRAFT_KEY: ${expectedDraftKey}`, 'info')
      } else {
        log('âš ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒæœªè¨­å®šã§ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚', 'error')
      }
    }

    function checkAllDrafts() {
      clearLog()
      log('=== LocalStorageå†…ã®å…¨Draftã‚­ãƒ¼ç¢ºèª ===')
      
      let draftCount = 0
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i)
        if (key && key.startsWith('draft_')) {
          draftCount++
          const value = localStorage.getItem(key)
          log(`\nğŸ“‹ ã‚­ãƒ¼: ${key}`, 'info')
          
          try {
            const parsed = JSON.parse(value)
            log(`  ä¿å­˜æ—¥æ™‚: ${parsed.savedAt || 'ä¸æ˜'}`)
            log(`  ãƒ‡ãƒ¼ã‚¿é …ç›®æ•°: ${Object.keys(parsed).length}`)
            log(`  ä¸»è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰:`)
            if (parsed.eventName) log(`    - ã‚¤ãƒ™ãƒ³ãƒˆå: ${parsed.eventName}`)
            if (parsed.eventDate) log(`    - ã‚¤ãƒ™ãƒ³ãƒˆæ—¥: ${parsed.eventDate}`)
            if (parsed.venueName) log(`    - ä¼šå ´å: ${parsed.venueName}`)
            if (parsed.staffName) log(`    - ã‚¹ã‚¿ãƒƒãƒ•å: ${parsed.staffName}`)
            if (parsed.agencyName) log(`    - ä»£ç†åº—å: ${parsed.agencyName}`)
            
            log(`  å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿:`)
            log(JSON.stringify(parsed, null, 2), 'success')
          } catch (e) {
            log(`  âš ï¸ JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error')
            log(`  ç”Ÿãƒ‡ãƒ¼ã‚¿: ${value}`)
          }
        }
      }
      
      if (draftCount === 0) {
        log('âŒ Draft ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'error')
      } else {
        log(`\nâœ… åˆè¨ˆ ${draftCount} ä»¶ã®DraftãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`, 'success')
      }
    }

    function checkSpecificDraft() {
      clearLog()
      log('=== ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®Draftç¢ºèª ===')
      
      const userName = localStorage.getItem('userName')
      if (!userName) {
        log('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒæœªè¨­å®šã§ã™ã€‚å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚', 'error')
        return
      }
      
      const draftKey = `draft_performance_form_${userName}`
      log(`ç¢ºèªã™ã‚‹ã‚­ãƒ¼: ${draftKey}`, 'info')
      
      const draftData = localStorage.getItem(draftKey)
      
      if (!draftData) {
        log('âŒ ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®Draftãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“', 'error')
        log('è€ƒãˆã‚‰ã‚Œã‚‹åŸå› :', 'info')
        log('1. ã¾ã ä¸€åº¦ã‚‚ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›ã—ã¦ã„ãªã„')
        log('2. 2ç§’ä»¥ä¸Šå¾…ãŸãšã«é›¢è„±ã—ãŸï¼ˆè‡ªå‹•ä¿å­˜ãŒå‹•ä½œã—ã¦ã„ãªã„ï¼‰')
        log('3. ãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã•ã‚ŒãŸãŒã‚­ãƒ¼ãŒç•°ãªã‚‹')
        return
      }
      
      try {
        const parsed = JSON.parse(draftData)
        log('âœ… Draftãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼', 'success')
        log(`\nä¿å­˜æ—¥æ™‚: ${parsed.savedAt || 'ä¸æ˜'}`)
        log(`ãƒ‡ãƒ¼ã‚¿é …ç›®æ•°: ${Object.keys(parsed).length}`)
        log('\nå®Œå…¨ãªãƒ‡ãƒ¼ã‚¿:')
        log(JSON.stringify(parsed, null, 2), 'success')
        
        log('\nä¸»è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤:')
        Object.keys(parsed).forEach(key => {
          if (key !== 'savedAt' && parsed[key] !== undefined && parsed[key] !== null && parsed[key] !== '') {
            log(`  ${key}: ${JSON.stringify(parsed[key])}`)
          }
        })
      } catch (e) {
        log(`âŒ JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error')
        log(`ç”Ÿãƒ‡ãƒ¼ã‚¿: ${draftData}`)
      }
    }

    function clearAllDrafts() {
      if (!confirm('æœ¬å½“ã«å…¨ã¦ã®Draftãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        return
      }
      
      clearLog()
      log('=== å…¨Draftãƒ‡ãƒ¼ã‚¿å‰Šé™¤ ===')
      
      const keysToDelete = []
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i)
        if (key && key.startsWith('draft_')) {
          keysToDelete.push(key)
        }
      }
      
      keysToDelete.forEach(key => {
        localStorage.removeItem(key)
        log(`å‰Šé™¤: ${key}`, 'info')
      })
      
      log(`\nâœ… ${keysToDelete.length} ä»¶ã®Draftã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'success')
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•ãƒã‚§ãƒƒã‚¯
    window.addEventListener('load', () => {
      log('=== è‡ªå‹•ãƒã‚§ãƒƒã‚¯é–‹å§‹ ===', 'info')
      checkUserName()
      setTimeout(() => {
        log('\n', 'info')
        checkAllDrafts()
      }, 500)
    })
  </script>
</body>
</html>
